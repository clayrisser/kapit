<!DOCTYPE html><html lang="en"><head><title>exec</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="exec"><meta name="groc-project-path" content="lib/exec.js"><meta name="groc-github-url" content="https://github.com/kelsin/kapit"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/kelsin/kapit/blob/master/lib/exec.js">lib/exec.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> handlebars = <span class="hljs-built_in">require</span>(<span class="hljs-string">'handlebars'</span>);
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">var</span> osenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'osenv'</span>);
<span class="hljs-keyword">var</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);

<span class="hljs-keyword">var</span> webdriver = <span class="hljs-built_in">require</span>(<span class="hljs-string">'selenium-webdriver'</span>);
<span class="hljs-keyword">var</span> chrome = <span class="hljs-built_in">require</span>(<span class="hljs-string">'selenium-webdriver/chrome'</span>);

<span class="hljs-keyword">var</span> data = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./data'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Runs the provided javascript object through handlebars</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> compile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request)</span> {</span>
  <span class="hljs-keyword">var</span> context = data.context();

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loop</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">if</span> (_.isArray(obj)) {
      <span class="hljs-keyword">return</span> _.map(obj, loop);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isPlainObject(obj)) {
      <span class="hljs-keyword">return</span> _.mapValues(obj, loop);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isString(obj)) {
      <span class="hljs-keyword">return</span> handlebars.compile(obj, { noEscape: <span class="hljs-literal">true</span> })(context);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> obj;
    }
  }

  <span class="hljs-keyword">return</span> loop(request);
};

exports.step = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
  step.compiled = compile(step.request);

  <span class="hljs-keyword">switch</span> (step.type) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">'HTTP'</span>:
    <span class="hljs-keyword">return</span> exports.http(step);
  <span class="hljs-keyword">case</span> <span class="hljs-string">'OAUTH'</span>:
    <span class="hljs-keyword">return</span> exports.oauth(step);
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">return</span> promise.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unknown request type: '</span> + step.type));
  }
};

exports.http = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> promise(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> {</span>
    request(step.compiled, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error, response, body)</span> {</span>
      step.response.status = response.statusCode;
      step.response.completed = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">if</span>(error || response.statusCode !== <span class="hljs-number">200</span>) {
        step.response.error = <span class="hljs-literal">true</span>;
      }

      step.response.headers = response.headers;
      step.response.body = body;

      resolve(step.response);
    });
  });
};

exports.oauth = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
  <span class="hljs-keyword">switch</span> (step.request.action) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">'authorize'</span>:
    <span class="hljs-keyword">return</span> exports.oauthAuthorize(step);
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">return</span> promise.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unknown OAuth action: '</span> + step.request.action));
  }
};

exports.driver = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(browser)</span> {</span>
  browser = browser || <span class="hljs-string">'phantomjs'</span>;

  <span class="hljs-keyword">var</span> builder = <span class="hljs-keyword">new</span> webdriver.Builder()
        .withCapabilities(webdriver.Capabilities[browser]());

  <span class="hljs-keyword">if</span> (browser === <span class="hljs-string">'chrome'</span>) {
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">new</span> chrome.Options();
    options.addArguments(<span class="hljs-string">'user-data-dir='</span> + osenv.home() + <span class="hljs-string">'/.kapit/chrome-profile'</span>);
    builder.setChromeOptions(options);
  }

  <span class="hljs-keyword">return</span> builder.build();
};

exports.oauthAuthorize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
  <span class="hljs-keyword">var</span> compiled = step.compiled.data;

  <span class="hljs-keyword">var</span> driver = exports.driver(compiled.browser);

  <span class="hljs-keyword">var</span> endpoint = url.parse(step.compiled.url);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> promise(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve)</span> {</span>
    driver
      .get(url.format(endpoint))
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        driver.switchTo();

        driver.wait(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">return</span> driver.getTitle().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(title)</span> {</span>
            <span class="hljs-keyword">return</span> title.indexOf(compiled.redirect_uri) === <span class="hljs-number">0</span>;
          });
        }, <span class="hljs-number">60000</span>);

        driver.getTitle().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(title)</span> {</span>
          step.response.completed = <span class="hljs-literal">true</span>;
          step.response.code = url.parse(title.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">0</span>], <span class="hljs-literal">true</span>).query.code;
        });

        driver.quit().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          resolve(step.response);
        });
      });
  });
};</div></div></div></div></body></html>