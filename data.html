<!DOCTYPE html><html lang="en"><head><title>data</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="data"><meta name="groc-project-path" content="lib/data.js"><meta name="groc-github-url" content="https://github.com/kelsin/kapit"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/kelsin/kapit/blob/master/lib/data.js">lib/data.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> osenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'osenv'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
promise.promisifyAll(fs);

<span class="hljs-keyword">var</span> mkdirp = promise.promisify(<span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>));

exports.configDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> path.join(osenv.home(),
                   process.platform === <span class="hljs-string">'win32'</span> ? <span class="hljs-string">'_kapit'</span> : <span class="hljs-string">'.kapit'</span>);
};

exports.defaultDataFilename = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> path.join(exports.configDir(), <span class="hljs-string">'state.json'</span>);
};

<span class="hljs-keyword">var</span> defaults = {
  current: -<span class="hljs-number">1</span>,
  chains: []
};

<span class="hljs-keyword">var</span> data = _.cloneDeep(defaults);

<span class="hljs-keyword">var</span> newChain = {
  name: <span class="hljs-string">'New Chain'</span>,
  current: -<span class="hljs-number">1</span>,
  steps: []
};

<span class="hljs-keyword">var</span> newStep = {
  name: <span class="hljs-string">'New Request'</span>,
  type: <span class="hljs-string">'HTTP'</span>,
  raw: <span class="hljs-literal">false</span>,
  request: {
    url: <span class="hljs-string">''</span>,
    method: <span class="hljs-string">'GET'</span>,
    json: <span class="hljs-literal">true</span>
  },
  response: {
    completed: <span class="hljs-literal">false</span>,
    error: <span class="hljs-literal">false</span>
  },
  render: {}
};

exports.getFilename = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> data.filename;
};

exports.raw = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> exports.getCurrentStep().raw;
};

exports.toggleRaw = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> step = exports.getCurrentStep();
  step.raw = !step.raw;
};

exports.save = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> filename = data.filename || exports.defaultDataFilename();

  <span class="hljs-keyword">return</span> mkdirp(exports.configDir())
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">return</span> fs.writeFileAsync(filename,
                               <span class="hljs-built_in">JSON</span>.stringify(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>),
                               { mode: <span class="hljs-number">384</span> });
    });
};

exports.load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> filename = process.argv[<span class="hljs-number">2</span>] || exports.defaultDataFilename();

  <span class="hljs-keyword">return</span> fs.readFileAsync(filename)
    .then(<span class="hljs-built_in">JSON</span>.parse)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val)</span> {</span>
      data = val;
      <span class="hljs-keyword">return</span> data;
    })
    .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there is no data file to load, just use the defaults</p></div></div><div class="code"><div class="wrapper">      data = _.cloneDeep(defaults);
      data.filename = filename;
    });
};

exports.getChains = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> data.chains;
};

exports.getChainNames = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> _.map(data.chains, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chain)</span> {</span>
    <span class="hljs-keyword">return</span> chain.name;
  });
};

exports.getChain = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index)</span> {</span>
  <span class="hljs-keyword">return</span> data.chains[index] || <span class="hljs-literal">null</span>;
};

exports.getCurrentChain = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> exports.getChain(data.current);
};

exports.getCurrentSteps = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">if</span> (_.isArray(chain.steps)) {
    <span class="hljs-keyword">return</span> chain.steps;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> [];
  }
};

exports.getCurrentStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">if</span> (chain) {
    <span class="hljs-keyword">return</span> chain.steps[chain.current];
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
};

exports.newChain = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> c = _.cloneDeep(newChain);
  <span class="hljs-keyword">var</span> length = data.chains.push(c);
  data.current = length - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> c;
};

exports.newStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> s = _.cloneDeep(newStep);
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">var</span> length = chain.steps.push(s);
  chain.current = length - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> s;
};

exports.deleteStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">var</span> removed = chain.steps.splice(chain.current, <span class="hljs-number">1</span>);

  chain.current--;
  <span class="hljs-keyword">if</span> (chain.steps.length &gt; <span class="hljs-number">0</span> &amp;&amp; chain.current === -<span class="hljs-number">1</span>) {
    chain.current = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">return</span> removed;
};

exports.resetAllSteps = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
  _.each((d || data).chains, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chain)</span> {</span>
    _.each(chain.steps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
      exports.resetStep(step);
    });
  });
};

exports.resetStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span>
  step = step || exports.getCurrentStep();
  step.response = _.cloneDeep(newStep.response);
  <span class="hljs-keyword">delete</span> step.compiled;
  <span class="hljs-keyword">delete</span> step.render.response;
};

exports.nextStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">if</span> (chain) {
    chain.current = <span class="hljs-built_in">Math</span>.min((chain.steps.length - <span class="hljs-number">1</span>), chain.current + <span class="hljs-number">1</span>);
  }
};

exports.prevStep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();
  <span class="hljs-keyword">if</span> (chain) {
    chain.current = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, chain.current - <span class="hljs-number">1</span>);
  }
};

exports.context = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> chain = exports.getCurrentChain();

  <span class="hljs-keyword">if</span> (chain) {
    <span class="hljs-keyword">return</span> _.reduce(chain.steps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context, step)</span> {</span>
      context[step.name] = {
        request: _.cloneDeep(step.request),
        response: _.cloneDeep(step.response)
      };

      <span class="hljs-keyword">return</span> context;
    }, {});
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
};</div></div></div></div></body></html>